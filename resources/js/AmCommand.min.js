!function(a){Craft.AmCommand=Garnish.Base.extend({$searchField:a(".amcommand__search input[type=text]"),$container:a(".amcommand"),$tabsContainer:a(".amcommand__tabs"),$searchContainer:a(".amcommand__search"),$commandsContainer:a(".amcommand__commands ul"),$loader:a(".amcommand__loader"),$commands:a(".amcommand__commands li"),$button:a("#nav-amcommand"),$buttonExecute:a(".amcommand__search input[type=button]"),ignoreSearchKeys:[Garnish.UP_KEY,Garnish.DOWN_KEY,Garnish.LEFT_KEY,Garnish.RIGHT_KEY,Garnish.RETURN_KEY,Garnish.ESC_KEY],fuzzyOptions:{pre:"<strong>",post:"</strong>",extract:function(a){return a.name}},commandsArray:[],rememberPalette:{currentSet:0,commandNames:[],commandsArray:[],searchKeywords:[],actions:[]},isOpen:!1,isHtml:!1,isAction:!1,isActionAsync:!0,isActionRealtime:!1,actionData:[],actionTimer:!1,loading:!1,loadingCommand:"",P_KEY:80,init:function(a){var b=this;b.commandsArray=a,b.search(void 0,!0),b.bindEvents()},bindEvents:function(){var a=this;a.addListener(a.$button,"click",function(b){b.preventDefault(),a.openPalette()}),a.addListener(a.$searchField,"keyup","search"),a.addListener(window,"keydown",function(b){(b.metaKey||b.ctrlKey)&&b.shiftKey&&b.keyCode==a.P_KEY?a.openPalette(b):b.keyCode==Garnish.UP_KEY?a.moveCommandFocus(b,"up"):b.keyCode==Garnish.DOWN_KEY?a.moveCommandFocus(b,"down"):b.keyCode==Garnish.RETURN_KEY?a.triggerCommand(b,b.metaKey||b.ctrlKey):b.keyCode==Garnish.ESC_KEY&&(a.rememberPalette.currentSet>0?a.restoreCommands():a.closePalette(b))}),a.addListener(a.$buttonExecute,"click","triggerCommand"),a.addListener(document.body,"click","closePalette"),a.addListener(a.$container,"click",function(a){a.stopPropagation()})},openPalette:function(a){var b=this;b.isOpen||(b.$container.fadeIn(1,function(){b.isOpen=!0,b.$searchField.focus()}),a.preventDefault())},closePalette:function(a){var b=this;b.isOpen&&(b.$container.fadeOut(1,function(){b.$buttonExecute.addClass("hidden"),b.$searchContainer.removeClass("amcommand__search--hasButton"),b.$searchField.val(""),b.$tabsContainer.addClass("hidden"),b.rememberPalette.currentSet>0&&(b.isAction=!1,b.isActionAsync=!0,b.isActionRealtime=!1,b.actionData=[],b.rememberPalette.currentSet=0,b.commandsArray=b.rememberPalette.commandsArray[1]),b.search(void 0,!0),b.isOpen=!1,b.loading=!1}),void 0!==a&&a.preventDefault())},resetPalette:function(){var b=this;b.$commands=a(".amcommand__commands li"),b.addListener(b.$commands,"click","triggerCommand"),b.$commands.first().addClass("focus")},search:function(b,c,d){var e=this;if(c||!e.isOpen||e.loading||e.ignoreSearchKeys.indexOf(b.keyCode)<0&&(c=!0),c)if(!e.isAction||d){var f=d?"":e.$searchField.val(),g=fuzzy.filter(f,e.commandsArray,e.fuzzyOptions),i=(g.length,g.map(function(a){var b='<span class="amcommand__commands--name'+("more"in a.original&&a.original.more?" go":"")+'">'+a.string+"</span>",c="info"in a.original?'<span class="amcommand__commands--info">'+a.original.info+"</span>":"";return'<li data-id="'+a.index+'">'+b+c+"</li>"}));e.$commandsContainer.html(i.join("")),e.resetPalette()}else e.isAction&&e.isActionRealtime&&(e.actionTimer&&clearTimeout(e.actionTimer),e.actionTimer=setTimeout(a.proxy(function(){e.triggerRealtimeAction()},this),600))},moveCommandFocus:function(a,b){var c=this;if(c.isOpen){var d=c.$commands.filter(".focus");switch(b){case"up":var e=d.prev();e.length&&(e.addClass("focus"),d.removeClass("focus"),c.keepCommandVisible(e));break;case"down":var f=d.next();f.length&&(f.addClass("focus"),d.removeClass("focus"),c.keepCommandVisible(f))}a.preventDefault()}},keepCommandVisible:function(a){var b=this,c=a.offset().top,d=a.outerHeight(),e=b.$commandsContainer.offset().top,f=b.$commandsContainer.scrollTop(),g=b.$commandsContainer.height();c+d>g+e?b.$commandsContainer.scrollTop(c-e-g+d+f):c<e&&b.$commandsContainer.scrollTop(f-e+c)},displayMessage:function(a,b,c){a?!1!==b?Craft.cp.displayNotice(b):Craft.cp.displayNotice('<span class="amcommand__notice">'+Craft.t("Command executed")+" &raquo;</span>"+c):Craft.cp.displayError(b)},rememberCommands:function(){var a=this,b={isAction:a.isAction,isActionAsync:a.isActionAsync,isActionRealtime:a.isActionRealtime,actionData:a.actionData};a.rememberPalette.currentSet++,a.rememberPalette.commandNames[a.rememberPalette.currentSet]=a.loadingCommand,a.rememberPalette.commandsArray[a.rememberPalette.currentSet]=a.commandsArray,a.rememberPalette.searchKeywords[a.rememberPalette.currentSet]=a.$searchField.val(),a.rememberPalette.actions[a.rememberPalette.currentSet]=b,a.isAction&&!a.isActionRealtime&&(a.isAction=!1,a.isActionAsync=!0,a.actionData=[],a.$buttonExecute.addClass("hidden"),a.$searchContainer.removeClass("amcommand__search--hasButton"))},restoreCommands:function(){var a=this,b=a.rememberPalette.actions[a.rememberPalette.currentSet];a.isHtml&&(a.isHtml=!1,a.$searchContainer.removeClass("hidden"),a.$container.velocity({width:"400px"},400)),a.isAction&&(a.isAction=!1,a.isActionAsync=!0,a.isActionRealtime=!1,a.actionData=[],a.$buttonExecute.addClass("hidden"),a.$searchContainer.removeClass("amcommand__search--hasButton")),a.commandsArray=a.rememberPalette.commandsArray[a.rememberPalette.currentSet],a.$searchField.val(a.rememberPalette.searchKeywords[a.rememberPalette.currentSet]),a.$searchField.focus(),a.search(void 0,!0),a.rememberPalette.currentSet--,a.rememberPalette.currentSet>0?a.$tabsContainer.text(a.rememberPalette.commandNames[a.rememberPalette.currentSet]):a.$tabsContainer.addClass("hidden"),b.isAction&&(a.isAction=!0,a.isActionAsync=b.isActionAsync,a.isActionRealtime=b.isActionRealtime,a.actionData=b.actionData,a.isActionRealtime||(a.$buttonExecute.removeClass("hidden"),a.$searchContainer.addClass("amcommand__search--hasButton")))},triggerRealtimeAction:function(){var a=this;a.actionTimer&&(clearTimeout(a.actionTimer),a.actionTimer=!1);var b=a.actionData.vars;b.searchText=a.$searchField.val(),a.loading=!0,a.triggerCallback(a.actionData.call,a.actionData.service,b)},triggerCommand:function(b,c){var d=this;if(d.isOpen&&!d.loading){if(d.isAction&&!d.isActionRealtime){var e=d.actionData.vars;e.searchText=d.$searchField.val(),d.loading=!0,d.triggerCallback(d.actionData.call,d.actionData.service,e)}else{if("click"==b.type){(b.ctrlKey||b.metaKey)&&(c=!0);var f=a(b.currentTarget);d.$commands.removeClass("focus"),f.addClass("focus")}else var f=d.$commands.filter(".focus");if(f.length){var g=f.data("id");if(g in d.commandsArray){var h=!0,i=d.commandsArray[g],j="warn"in i&&i.warn,k="url"in i&&i.url,l="call"in i&&i.call,m="service"in i&&i.service,n="vars"in i&&i.vars;if(d.loadingCommand=i.name,j){confirm(Craft.t("Are you sure you want to execute this command?"))||(h=!1)}h&&(d.loading=!0,l?d.triggerCallback(l,m,n):k&&(c?window.open(k):window.location=k,d.displayMessage(!0,!1,i.name),d.closePalette(b)))}}}b.preventDefault()}},triggerCallback:function(b,c,d){var e=this,f=!1,g=e.$commands.filter(".focus");e.$commands.hide(),e.$loader.removeClass("hidden"),Craft.postActionRequest("amCommand/commands/triggerCommand",{command:b,service:c,vars:d},a.proxy(function(a,b){"success"==b&&(e.loading=!1,e.$loader.addClass("hidden"),a.success?(a.title&&(e.loadingCommand=a.title),a.isHtml?""==a.result?e.$commands.show():(e.rememberCommands(),e.isHtml=!0,e.$tabsContainer.text(e.loadingCommand),e.$tabsContainer.removeClass("hidden"),e.$searchContainer.addClass("hidden"),e.$container.velocity({width:"80%"},400),e.$commandsContainer.html(a.result),Craft.appendHeadHtml(a.headHtml),Craft.appendFootHtml(a.footHtml),Craft.initUiElements(e.$commandsContainer)):e.isAction&&e.isActionRealtime&&a.isNewSet?(e.commandsArray=a.result,e.search(void 0,!0,!0)):a.isAction?(e.loadingCommand=a.isAction.tabs,e.rememberCommands(),e.isAction=!0,e.isActionAsync=a.isAction.async,e.isActionRealtime=a.isAction.realtime,e.actionData=a.isAction,e.$tabsContainer.text(a.isAction.tabs),e.$tabsContainer.removeClass("hidden"),a.isAction.realtime||(e.$buttonExecute.removeClass("hidden"),e.$searchContainer.addClass("amcommand__search--hasButton")),e.commandsArray=[],e.$commandsContainer.html(""),e.$searchField.val(a.isAction.searchText),e.$searchField.focus()):a.isNewSet?""==a.result?e.$commands.show():(e.rememberCommands(),e.$tabsContainer.text(e.loadingCommand),e.$tabsContainer.removeClass("hidden"),e.$searchField.val(""),e.$searchField.focus(),e.commandsArray=a.result,e.search(void 0,!0)):a.deleteCommand?(e.$searchField.val(""),e.$searchField.focus(),e.$commands.removeClass("focus"),e.deleteCommand(g.data("id")),e.search(void 0,!0),e.$commands.show(),e.commandsArray.length<=0&&(e.displayMessage(!1,Craft.t("There are no more commands available."),!1),e.closePalette())):(f=!0,e.closePalette()),a.message?e.displayMessage(""!=a.result,a.message,!1):f&&e.displayMessage(!0,!1,g.children(".amcommand__commands--name").text()),a.redirect&&(a.redirect.newWindow?window.open(a.redirect.url):window.location=a.redirect.url)):(e.isAction&&e.isActionRealtime&&(e.commandsArray=[],e.$commandsContainer.html("")),e.$commands.show(),e.$searchField.focus(),e.displayMessage(!1,a.message,!1)))},e),{async:e.isActionAsync})},deleteCommand:function(a){var b=this,c=b.commandsArray.length;if(c){for(;a<c;)b.commandsArray[a]=b.commandsArray[a+1],a++;b.commandsArray.length--}}})}(jQuery);
