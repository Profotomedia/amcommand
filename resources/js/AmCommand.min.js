!function(e){Craft.AmCommand=Garnish.Base.extend({$searchField:e(".amcommand__search input[type=text]"),$container:e(".amcommand"),$tabsContainer:e(".amcommand__tabs"),$searchContainer:e(".amcommand__search"),$commandsContainer:e(".amcommand__commands ul"),$loader:e(".amcommand__loader"),$commands:e(".amcommand__commands li"),$button:e("#nav-amcommand"),P_KEY:80,NUM_KEYS:[49,50,51,52,53,54,55,56,57],ignoreSearchKeys:[Garnish.UP_KEY,Garnish.DOWN_KEY,Garnish.LEFT_KEY,Garnish.RIGHT_KEY,Garnish.RETURN_KEY,Garnish.ESC_KEY,Garnish.CMD_KEY,Garnish.CTRL_KEY],fuzzyOptions:{pre:"<strong>",post:"</strong>",extract:function(e){return e.name}},commandsArray:[],elementCommandsArray:[],combinedCommandsArray:[],rememberPalette:{currentSet:0,paletteStyle:[],commandNames:[],commandsArray:[],searchKeywords:[],actions:[]},isOpen:!1,isHtml:!1,isAction:!1,isActionAsync:!0,isActionRealtime:!1,actionData:[],actionTimer:!1,loading:!1,loadingCommand:"",allowElementSearch:!0,elementSearchTimer:!1,init:function(e){var a=this;a.commandsArray=e,a.combinedCommandsArray=e,a.bindEvents()},bindEvents:function(){var a=this;a.addListener(a.$button,"click","openPalette"),a.addListener(a.$searchField,"keyup",function(n){a.ignoreSearchKeys.indexOf(n.keyCode)<0&&(a.search(n,!1),a.isOpen&&a.allowElementSearch&&a.$searchField.val().length&&(a.elementSearchTimer&&clearTimeout(a.elementSearchTimer),a.elementSearchTimer=setTimeout(e.proxy(function(){var e={option:"Elements",searchText:a.$searchField.val()};a.loading=!0,a.triggerCallback("searchOn","amCommand_search",e,!0)},this),600)))}),a.addListener(window,"keydown",function(e){(e.metaKey||e.ctrlKey)&&e.shiftKey&&e.keyCode==a.P_KEY?a.isOpen?a.closePalette(e):a.openPalette(e):(e.metaKey||e.ctrlKey)&&a.NUM_KEYS.indexOf(e.keyCode)>-1?a.triggerCommand(e,!1):e.keyCode==Garnish.UP_KEY?a.moveCommandFocus(e,"up"):e.keyCode==Garnish.DOWN_KEY?a.moveCommandFocus(e,"down"):e.keyCode==Garnish.RETURN_KEY?a.triggerCommand(e,e.metaKey||e.ctrlKey):e.keyCode==Garnish.ESC_KEY&&(a.rememberPalette.currentSet>0?a.restoreCommands():a.closePalette(e))}),a.addListener(document.body,"click","closePalette"),a.addListener(a.$container,"click",function(e){e.stopPropagation()})},openPalette:function(e){var a=this;a.isOpen||(a.$container.fadeIn(1,function(){a.isOpen=!0,a.$searchField.focus(),a.$commandsContainer.addClass("hidden")}),e.preventDefault())},closePalette:function(e){var a=this;a.isOpen&&(a.$container.fadeOut(1,function(){a.$searchField.val(""),a.$tabsContainer.addClass("hidden"),a.rememberPalette.currentSet>0&&(a.isAction=!1,a.isActionAsync=!0,a.isActionRealtime=!1,a.actionData=[],a.rememberPalette.currentSet=0,a.commandsArray=a.rememberPalette.commandsArray[1]),a.search(e,!1),a.isOpen=!1,a.loading=!1}),void 0!==e&&e.preventDefault())},resetPalette:function(){var a=this;a.$commands=e(".amcommand__commands li"),a.addListener(a.$commands,"click","triggerCommand"),a.$commands.first().addClass("focus")},search:function(a,n){var t=this;if(!t.isAction||n){var r=t.allowElementSearch?t.combinedCommandsArray:t.commandsArray,i=n?"":t.$searchField.val(),o=fuzzy.filter(i,r,t.fuzzyOptions);o.length;if(!t.allowElementSearch||i.length&&t.allowElementSearch){var s=o.map(function(e,a){var n=a<9?'<span class="right">&#8984;'+(a+1)+"</span>":"",t='<span class="amcommand__commands--name'+("more"in e.original&&e.original.more?" go":"")+'">'+e.string+"</span>",r="info"in e.original?'<span class="amcommand__commands--info">'+e.original.info+"</span>":"";return'<li data-id="'+e.index+'">'+n+t+r+"</li>"});t.$commandsContainer.removeClass("hidden"),t.$commandsContainer.html(s.join("")),s.length||t.$commandsContainer.addClass("hidden"),t.resetPalette()}else t.$commandsContainer.html(""),t.$commandsContainer.addClass("hidden")}else t.isAction&&t.isActionRealtime&&(t.actionTimer&&clearTimeout(t.actionTimer),t.actionTimer=setTimeout(e.proxy(function(){t.triggerRealtimeAction()},this),600))},moveCommandFocus:function(e,a){var n=this;if(n.isOpen){var t=n.$commands.filter(".focus");switch(a){case"up":var r=t.prev();r.length&&(r.addClass("focus"),t.removeClass("focus"),n.keepCommandVisible(r));break;case"down":var i=t.next();i.length&&(i.addClass("focus"),t.removeClass("focus"),n.keepCommandVisible(i))}e.preventDefault()}},keepCommandVisible:function(e){var a=this,n=e.offset().top,t=e.outerHeight(),r=a.$commandsContainer.offset().top,i=a.$commandsContainer.scrollTop(),o=a.$commandsContainer.height();n+t>o+r?a.$commandsContainer.scrollTop(n-r-o+t+i):n<r&&a.$commandsContainer.scrollTop(i-r+n)},displayMessage:function(e,a,n){e?!1!==a?Craft.cp.displayNotice(a):Craft.cp.displayNotice('<span class="amcommand__notice">'+Craft.t("Command executed")+" &raquo;</span>"+n):Craft.cp.displayError(a)},rememberCommands:function(){var e=this,a={isAction:e.isAction,isActionAsync:e.isActionAsync,isActionRealtime:e.isActionRealtime,actionData:e.actionData};e.rememberPalette.currentSet++,e.rememberPalette.paletteStyle[e.rememberPalette.currentSet]={width:e.$container.width()},e.rememberPalette.commandNames[e.rememberPalette.currentSet]=e.loadingCommand,e.rememberPalette.commandsArray[e.rememberPalette.currentSet]=e.commandsArray,e.rememberPalette.searchKeywords[e.rememberPalette.currentSet]=e.$searchField.val(),e.rememberPalette.actions[e.rememberPalette.currentSet]=a,e.isAction&&!e.isActionRealtime&&(e.isAction=!1,e.isActionAsync=!0,e.actionData=[]),e.rememberPalette.currentSet>0&&(e.allowElementSearch=!1)},restoreCommands:function(){var a=this,n=a.rememberPalette.actions[a.rememberPalette.currentSet];a.isHtml&&(a.isHtml=!1,a.$searchContainer.removeClass("hidden"),a.$container.velocity(a.rememberPalette.paletteStyle[a.rememberPalette.currentSet],400)),a.isAction&&(a.isAction=!1,a.isActionAsync=!0,a.isActionRealtime=!1,a.actionData=[]),a.commandsArray=a.rememberPalette.commandsArray[a.rememberPalette.currentSet],a.$searchField.val(a.rememberPalette.searchKeywords[a.rememberPalette.currentSet]),a.$searchField.focus(),0==--a.rememberPalette.currentSet&&(a.allowElementSearch=!0,a.combinedCommandsArray=e.extend([],a.commandsArray,a.elementCommandsArray)),a.search(void 0,!1),a.rememberPalette.currentSet>0?a.$tabsContainer.text(a.rememberPalette.commandNames[a.rememberPalette.currentSet]):a.$tabsContainer.addClass("hidden"),n.isAction&&(a.isAction=!0,a.isActionAsync=n.isActionAsync,a.isActionRealtime=n.isActionRealtime,a.actionData=n.actionData)},triggerRealtimeAction:function(){var e=this;e.actionTimer&&(clearTimeout(e.actionTimer),e.actionTimer=!1);var a=e.actionData.vars;a.searchText=e.$searchField.val(),e.loading=!0,e.triggerCallback(e.actionData.call,e.actionData.service,a,!1)},triggerCommand:function(a,n){var t=this;if(t.isOpen&&!t.loading){if(t.isAction&&!t.isActionRealtime){var r=t.actionData.vars;r.searchText=t.$searchField.val(),t.loading=!0,t.triggerCallback(t.actionData.call,t.actionData.service,r,!1)}else{if("click"==a.type){(a.ctrlKey||a.metaKey)&&(n=!0);o=e(a.currentTarget);t.$commands.removeClass("focus"),o.addClass("focus")}else if("keydown"==a.type&&t.NUM_KEYS.indexOf(a.keyCode)>-1)var i=t.NUM_KEYS.indexOf(a.keyCode),o=t.$commands.filter(":eq("+i+")");else o=t.$commands.filter(".focus");if(o.length){var s=o.data("id"),m=t.allowElementSearch?t.combinedCommandsArray:t.commandsArray;if(s in m){var c=!0,d=m[s],l="warn"in d&&d.warn,h="url"in d&&d.url,C="call"in d&&d.call,u="service"in d&&d.service,y="vars"in d&&d.vars;t.loadingCommand=d.name,l&&(confirm(Craft.t("Are you sure you want to execute this command?"))||(c=!1)),c&&(t.loading=!0,C?t.triggerCallback(C,u,y,!1):h&&(n?window.open(h):window.location=h,t.displayMessage(!0,!1,d.name),t.closePalette(a)))}}}a.preventDefault()}},triggerCallback:function(a,n,t,r){var i=this,o=!1,s=i.$commands.filter(".focus");r||i.$commands.hide(),i.$loader.removeClass("hidden"),Craft.postActionRequest("amCommand/commands/triggerCommand",{command:a,service:n,vars:t},e.proxy(function(a,n){"success"==n&&(i.loading=!1,i.$loader.addClass("hidden"),a.success?(a.title&&(i.loadingCommand=a.title),a.isHtml?""==a.result?i.$commands.show():(i.rememberCommands(),i.isHtml=!0,i.$tabsContainer.text(i.loadingCommand),i.$tabsContainer.removeClass("hidden"),i.$searchContainer.addClass("hidden"),i.$container.velocity({width:"80%"},400),i.$commandsContainer.html(a.result),Craft.appendHeadHtml(a.headHtml),Craft.appendFootHtml(a.footHtml),Craft.initUiElements(i.$commandsContainer)):r&&a.isNewSet?(i.elementCommandsArray=a.result,i.combinedCommandsArray=e.extend([],i.commandsArray,i.elementCommandsArray),i.search(void 0,!1)):i.isAction&&i.isActionRealtime&&a.isNewSet?(i.commandsArray=a.result,i.search(void 0,!0)):a.isAction?(i.loadingCommand=a.isAction.tabs,i.rememberCommands(),i.isAction=!0,i.isActionAsync=a.isAction.async,i.isActionRealtime=a.isAction.realtime,i.actionData=a.isAction,i.$tabsContainer.text(a.isAction.tabs),i.$tabsContainer.removeClass("hidden"),i.commandsArray=[],i.$commandsContainer.html(""),i.$commandsContainer.addClass("hidden"),i.$searchField.val(a.isAction.searchText),i.$searchField.focus()):a.isNewSet?""==a.result?i.$commands.show():(i.rememberCommands(),i.$tabsContainer.text(i.loadingCommand),i.$tabsContainer.removeClass("hidden"),i.$searchField.val(""),i.$searchField.focus(),i.commandsArray=a.result,i.search(void 0,!1)):a.deleteCommand?(i.$searchField.val(""),i.$searchField.focus(),i.$commands.removeClass("focus"),i.deleteCommand(s.data("id")),i.search(void 0,!0),i.$commands.show(),i.commandsArray.length<=0&&(i.displayMessage(!1,Craft.t("There are no more commands available."),!1),i.closePalette())):(o=!0,i.closePalette()),a.message?i.displayMessage(""!=a.result,a.message,!1):o&&i.displayMessage(!0,!1,s.children(".amcommand__commands--name").text()),a.redirect&&(a.redirect.newWindow?window.open(a.redirect.url):window.location=a.redirect.url)):(i.isAction&&i.isActionRealtime&&(i.commandsArray=[],i.$commandsContainer.html(""),i.$commandsContainer.addClass("hidden")),i.$commands.show(),i.$searchField.focus(),r||i.displayMessage(!1,a.message,!1)))},i),{async:i.isActionAsync})},deleteCommand:function(e){var a=this,n=a.commandsArray.length;if(n){for(;e<n;)a.commandsArray[e]=a.commandsArray[e+1],e++;a.commandsArray.length--}}})}(jQuery);
