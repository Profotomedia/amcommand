!function(e){Craft.AmCommand=Garnish.Base.extend({$searchField:e(".amcommand__search input[type=text]"),$container:e(".amcommand"),$tabsContainer:e(".amcommand__tabs"),$searchContainer:e(".amcommand__search"),$commandsContainer:e(".amcommand__commands ul"),$loader:e(".amcommand__loader"),$commands:e(".amcommand__commands li"),$button:e("#nav-amcommand"),$buttonExecute:e(".amcommand__search input[type=button]"),ignoreSearchKeys:[Garnish.UP_KEY,Garnish.DOWN_KEY,Garnish.LEFT_KEY,Garnish.RIGHT_KEY,Garnish.RETURN_KEY,Garnish.ESC_KEY],fuzzyOptions:{pre:"<strong>",post:"</strong>",extract:function(e){return e.name}},commandsArray:[],rememberPalette:{currentSet:0,commandNames:[],commandsArray:[],searchKeywords:[],actions:[]},isOpen:!1,isAction:!1,isActionAsync:!0,isActionRealtime:!1,actionData:[],actionTimer:!1,loading:!1,loadingCommand:"",P_KEY:80,init:function(e){var a=this;a.commandsArray=e,a.search(void 0,!0),a.bindEvents()},bindEvents:function(){var e=this;e.addListener(e.$button,"click",function(a){a.preventDefault(),e.openPalette()}),e.addListener(e.$searchField,"keyup","search"),e.addListener(window,"keydown",function(a){(a.metaKey||a.ctrlKey)&&a.shiftKey&&a.keyCode==e.P_KEY?e.openPalette(a):a.keyCode==Garnish.UP_KEY?e.moveCommandFocus(a,"up"):a.keyCode==Garnish.DOWN_KEY?e.moveCommandFocus(a,"down"):a.keyCode==Garnish.RETURN_KEY?e.triggerCommand(a,a.metaKey||a.ctrlKey):a.keyCode==Garnish.ESC_KEY&&(e.rememberPalette.currentSet>0?e.restoreCommands():e.closePalette(a))}),e.addListener(e.$buttonExecute,"click","triggerCommand"),e.addListener(document.body,"click","closePalette"),e.addListener(e.$container,"click",function(e){e.stopPropagation()})},openPalette:function(e){var a=this;a.isOpen||(a.$container.fadeIn(1,function(){a.isOpen=!0,a.$searchField.focus()}),e.preventDefault())},closePalette:function(e){var a=this;a.isOpen&&(a.$container.fadeOut(1,function(){a.$buttonExecute.addClass("hidden"),a.$searchContainer.removeClass("amcommand__search--hasButton"),a.$searchField.val(""),a.$tabsContainer.addClass("hidden"),a.rememberPalette.currentSet>0&&(a.isAction=!1,a.isActionAsync=!0,a.isActionRealtime=!1,a.actionData=[],a.rememberPalette.currentSet=0,a.commandsArray=a.rememberPalette.commandsArray[1]),a.search(void 0,!0),a.isOpen=!1,a.loading=!1}),void 0!==e&&e.preventDefault())},resetPalette:function(){var a=this;a.$commands=e(".amcommand__commands li"),a.addListener(a.$commands,"click","triggerCommand"),a.$commands.first().addClass("focus")},search:function(a,t,n){var i=this;if(t||!i.isOpen||i.loading||i.ignoreSearchKeys.indexOf(a.keyCode)<0&&(t=!0),t)if(!i.isAction||n){var s=n?"":i.$searchField.val(),o=fuzzy.filter(s,i.commandsArray,i.fuzzyOptions),r=(o.length,o.map(function(e){var a='<span class="amcommand__commands--name'+("more"in e.original&&e.original.more?" go":"")+'">'+e.string+"</span>",t="info"in e.original?'<span class="amcommand__commands--info">'+e.original.info+"</span>":"";return'<li data-id="'+e.index+'">'+a+t+"</li>"}));i.$commandsContainer.html(r.join("")),i.resetPalette()}else i.isAction&&i.isActionRealtime&&(i.actionTimer&&clearTimeout(i.actionTimer),i.actionTimer=setTimeout(e.proxy(function(){i.triggerRealtimeAction()},this),600))},moveCommandFocus:function(e,a){var t=this;if(t.isOpen){var n=t.$commands.filter(".focus");switch(a){case"up":var i=n.prev();i.length&&(i.addClass("focus"),n.removeClass("focus"),t.keepCommandVisible(i));break;case"down":var s=n.next();s.length&&(s.addClass("focus"),n.removeClass("focus"),t.keepCommandVisible(s))}e.preventDefault()}},keepCommandVisible:function(e){var a=this,t=e.offset().top,n=e.outerHeight(),i=a.$commandsContainer.offset().top,s=a.$commandsContainer.scrollTop(),o=a.$commandsContainer.height();t+n>o+i?a.$commandsContainer.scrollTop(t-i-o+n+s):i>t&&a.$commandsContainer.scrollTop(s-i+t)},displayMessage:function(e,a,t){e?a!==!1?Craft.cp.displayNotice(a):Craft.cp.displayNotice('<span class="amcommand__notice">'+Craft.t("Command executed")+" &raquo;</span>"+t):Craft.cp.displayError(a)},rememberCommands:function(){var e=this,a={isAction:e.isAction,isActionAsync:e.isActionAsync,isActionRealtime:e.isActionRealtime,actionData:e.actionData};e.rememberPalette.currentSet++,e.rememberPalette.commandNames[e.rememberPalette.currentSet]=e.loadingCommand,e.rememberPalette.commandsArray[e.rememberPalette.currentSet]=e.commandsArray,e.rememberPalette.searchKeywords[e.rememberPalette.currentSet]=e.$searchField.val(),e.rememberPalette.actions[e.rememberPalette.currentSet]=a,e.isAction&&!e.isActionRealtime&&(e.isAction=!1,e.isActionAsync=!0,e.actionData=[],e.$buttonExecute.addClass("hidden"),e.$searchContainer.removeClass("amcommand__search--hasButton"))},restoreCommands:function(){var e=this,a=e.rememberPalette.actions[e.rememberPalette.currentSet];e.isAction&&(e.isAction=!1,e.isActionAsync=!0,e.isActionRealtime=!1,e.actionData=[],e.$buttonExecute.addClass("hidden"),e.$searchContainer.removeClass("amcommand__search--hasButton")),e.commandsArray=e.rememberPalette.commandsArray[e.rememberPalette.currentSet],e.$searchField.val(e.rememberPalette.searchKeywords[e.rememberPalette.currentSet]),e.$searchField.focus(),e.search(void 0,!0),e.rememberPalette.currentSet--,e.rememberPalette.currentSet>0?e.$tabsContainer.text(e.rememberPalette.commandNames[e.rememberPalette.currentSet]):e.$tabsContainer.addClass("hidden"),a.isAction&&(e.isAction=!0,e.isActionAsync=a.isActionAsync,e.isActionRealtime=a.isActionRealtime,e.actionData=a.actionData,e.isActionRealtime||(e.$buttonExecute.removeClass("hidden"),e.$searchContainer.addClass("amcommand__search--hasButton")))},triggerRealtimeAction:function(){var e=this;e.actionTimer&&(clearTimeout(e.actionTimer),e.actionTimer=!1);var a=e.actionData.vars;a.searchText=e.$searchField.val(),e.loading=!0,e.triggerCallback(e.actionData.call,e.actionData.service,a)},triggerCommand:function(a,t){var n=this;if(n.isOpen&&!n.loading){if(n.isAction&&!n.isActionRealtime){var i=n.actionData.vars;i.searchText=n.$searchField.val(),n.loading=!0,n.triggerCallback(n.actionData.call,n.actionData.service,i)}else{if("click"==a.type){(a.ctrlKey||a.metaKey)&&(t=!0);var s=e(a.currentTarget);n.$commands.removeClass("focus"),s.addClass("focus")}else var s=n.$commands.filter(".focus");if(s.length){var o=s.data("id");if(o in n.commandsArray){var r=!0,c=n.commandsArray[o],m="warn"in c?c.warn:!1,d="url"in c?c.url:!1,l="call"in c?c.call:!1,u="service"in c?c.service:!1,h="vars"in c?c.vars:!1;if(n.loadingCommand=c.name,m){var C=confirm(Craft.t("Are you sure you want to execute this command?"));C||(r=!1)}r&&(n.loading=!0,l?n.triggerCallback(l,u,h):d&&(t?window.open(d):window.location=d,n.displayMessage(!0,!1,c.name),n.closePalette(a)))}}}a.preventDefault()}},triggerCallback:function(a,t,n){var i=this,s=!1,o=i.$commands.filter(".focus");i.$commands.hide(),i.$loader.removeClass("hidden"),Craft.postActionRequest("amCommand/commands/triggerCommand",{command:a,service:t,vars:n},e.proxy(function(e,a){"success"==a&&(i.loading=!1,i.$loader.addClass("hidden"),e.success?(e.title&&(i.loadingCommand=e.title),i.isAction&&i.isActionRealtime&&e.isNewSet?(i.commandsArray=e.result,i.search(void 0,!0,!0)):e.isAction?(i.loadingCommand=e.isAction.tabs,i.rememberCommands(),i.isAction=!0,i.isActionAsync=e.isAction.async,i.isActionRealtime=e.isAction.realtime,i.actionData=e.isAction,i.$tabsContainer.text(e.isAction.tabs),i.$tabsContainer.removeClass("hidden"),e.isAction.realtime||(i.$buttonExecute.removeClass("hidden"),i.$searchContainer.addClass("amcommand__search--hasButton")),i.commandsArray=[],i.$commandsContainer.html(""),i.$searchField.val(e.isAction.searchText),i.$searchField.focus()):e.isNewSet?""==e.result?i.$commands.show():(i.rememberCommands(),i.$tabsContainer.text(i.loadingCommand),i.$tabsContainer.removeClass("hidden"),i.$searchField.val(""),i.$searchField.focus(),i.commandsArray=e.result,i.search(void 0,!0)):e.deleteCommand?(i.$searchField.val(""),i.$searchField.focus(),i.$commands.removeClass("focus"),i.deleteCommand(o.data("id")),i.search(void 0,!0),i.$commands.show(),i.commandsArray.length<=0&&(i.displayMessage(!1,Craft.t("There are no more commands available."),!1),i.closePalette())):(s=!0,i.closePalette()),e.message?i.displayMessage(""!=e.result,e.message,!1):s&&i.displayMessage(!0,!1,o.children(".amcommand__commands--name").text()),e.redirect&&(e.redirect.newWindow?window.open(e.redirect.url):window.location=e.redirect.url)):(i.isAction&&i.isActionRealtime&&(i.commandsArray=[],i.$commandsContainer.html("")),i.$commands.show(),i.$searchField.focus(),i.displayMessage(!1,e.message,!1)))},i),{async:i.isActionAsync})},deleteCommand:function(e){var a=this,t=a.commandsArray.length;if(t){for(;t>e;)a.commandsArray[e]=a.commandsArray[e+1],e++;a.commandsArray.length--}}})}(jQuery);
