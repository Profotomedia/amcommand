(function($){Craft.AmCommand=Garnish.Base.extend({$searchField:$(".amcommand__search input[type=text]"),$container:$(".amcommand"),$tabsContainer:$(".amcommand__tabs"),$searchContainer:$(".amcommand__search"),$commandsContainer:$(".amcommand__commands"),$loader:$(".amcommand__loader"),$commands:$(".amcommand__commands li"),$button:$('<li><span class="customicon customicon__lightning" title="Command palette"></span></li>').prependTo("#header-actions"),$buttonExecute:$(".amcommand__search input[type=button]"),
ignoreSearchKeys:[Garnish.UP_KEY,Garnish.DOWN_KEY,Garnish.LEFT_KEY,Garnish.RIGHT_KEY,Garnish.RETURN_KEY,Garnish.ESC_KEY],fuzzyOptions:{pre:"<strong>",post:"</strong>"},commandsArray:[],rememberPalette:{commandsArray:null,commandsContainer:null},isOpen:false,isAction:false,actionData:[],loading:false,loadingCommand:"",loadedNewCommands:false,P_KEY:80,init:function(){var self=this;self.$commands.each(function(index,command){self.commandsArray.push($(command).children(".amcommand__commands--name").text().trim())});
self.$commands.first().addClass("focus");self.rememberPalette.commandsArray=self.commandsArray;self.rememberPalette.commandsContainer=self.$commandsContainer.html();self.bindEvents()},bindEvents:function(){var self=this;self.addListener(self.$button,"click","openPalette");self.addListener(self.$searchField,"keyup","search");self.addListener(window,"keydown",function(ev){if((ev.metaKey||ev.ctrlKey)&&ev.shiftKey&&ev.keyCode==self.P_KEY)self.openPalette(ev);else if(ev.keyCode==Garnish.UP_KEY)self.moveCommandFocus(ev,
"up");else if(ev.keyCode==Garnish.DOWN_KEY)self.moveCommandFocus(ev,"down");else if(ev.keyCode==Garnish.RETURN_KEY)self.triggerCommand(ev,ev.metaKey||ev.ctrlKey);else if(ev.keyCode==Garnish.ESC_KEY)self.closePalette(ev)});self.addListener(self.$commands,"click","triggerCommand");self.addListener(self.$buttonExecute,"click","triggerCommand");self.addListener(document.body,"click","closePalette");self.addListener(self.$container,"click",function(ev){ev.stopPropagation()})},openPalette:function(ev){var self=
this;if(!self.isOpen){self.$container.fadeIn(1,function(){self.isOpen=true;self.$searchField.focus()});ev.preventDefault()}},closePalette:function(ev){var self=this;if(self.isOpen){self.$container.fadeOut(1,function(){self.$buttonExecute.addClass("hidden");self.$searchContainer.removeClass("amcommand__search--hasButton");if(self.loadedNewCommands){self.isAction=false;self.actionData=[];self.loadedNewCommands=false;self.resetPalette(true)}self.$searchField.val("");self.isOpen=false;self.loading=false});
if(ev!==undefined)ev.preventDefault()}},resetPalette:function(resetToStart){var self=this;self.$searchField.val("");self.$searchField.focus();if(resetToStart){self.commandsArray=self.rememberPalette.commandsArray;self.$commandsContainer.html(self.rememberPalette.commandsContainer);self.$commands=$(".amcommand__commands li");self.$commands.show();self.$tabsContainer.addClass("hidden")}else{self.$commands=$(".amcommand__commands li");self.commandsArray=[];self.$commands.each(function(index,command){self.commandsArray.push($(command).children(".amcommand__commands--name").text().trim())})}self.addListener(self.$commands,
"click","triggerCommand");self.$commands.first().addClass("focus")},search:function(ev){var self=this;if(self.isOpen)if(self.ignoreSearchKeys.indexOf(ev.keyCode)<0){var searchValue=self.$searchField.val(),results=fuzzy.filter(searchValue,self.commandsArray,self.fuzzyOptions),totalResults=results.length;self.$commands.hide();if(totalResults)results.map(function(el){self.$commands.filter("[data-id="+el.index+"]").show().children(".amcommand__commands--name").html(el.string)});self.moveCommandFocus(ev,
"reset")}},moveCommandFocus:function(ev,direction){var self=this;if(self.isOpen){var $commands=self.$commands.filter(":visible"),$current=self.$commands.filter(".focus");switch(direction){case "up":if(!$current.length)$prev=$commands.first();else $prev=$current.prevAll(":visible").first();if($prev.length){$current.removeClass("focus");$prev.addClass("focus");self.keepCommandVisible($prev)}break;case "down":if(!$current.length)$next=$commands.first();else $next=$current.nextAll(":visible").first();
if($next.length){$current.removeClass("focus");$next.addClass("focus");self.keepCommandVisible($next)}break;case "reset":self.$commands.removeClass("focus");$commands.first().addClass("focus");break}ev.preventDefault()}},keepCommandVisible:function(current){var self=this,currentTop=current.offset().top,currentHeight=current.outerHeight(),containerTop=self.$commandsContainer.offset().top,containerScroll=self.$commandsContainer.scrollTop(),containerHeight=self.$commandsContainer.height();if(currentTop+
currentHeight>containerHeight+containerTop)self.$commandsContainer.scrollTop(currentTop-containerTop-containerHeight+currentHeight+containerScroll);else if(currentTop<containerTop)self.$commandsContainer.scrollTop(containerScroll-containerTop+currentTop)},displayMessage:function(success,customMessage,executedCommand){if(success)if(customMessage!==false)Craft.cp.displayNotice(customMessage);else Craft.cp.displayNotice('<span class="amcommand__notice">'+Craft.t("Command executed")+" &raquo;</span>"+
executedCommand);else Craft.cp.displayError(customMessage)},triggerCommand:function(ev,ctrlPressed){var self=this;if(self.isOpen&&!self.loading){if(ev.type=="click"){if(ev.ctrlKey||ev.metaKey)ctrlPressed=true;var $current=$(ev.currentTarget).children(".amcommand__commands--name");self.$commands.removeClass("focus");$current.parent().addClass("focus")}else var $current=self.$commands.filter(".focus").children(".amcommand__commands--name");if($current.length){var confirmed=true,warn=$current.data("warn"),
url=$current.data("url"),callback=$current.data("callback"),callbackService=$current.data("callback-service"),callbackVars=$current.data("callback-vars");self.loadingCommand=$current.text();if(warn!==undefined&&warn=="1"){var confirmation=confirm(Craft.t("Are you sure you want to execute this command?"));if(!confirmation)confirmed=false}if(confirmed){self.loading=true;if(callback!==undefined){if(callback===undefined)callbackService=false;self.triggerCallback(callback,callbackService,callbackVars)}else if(url!==
undefined){if(ctrlPressed)window.open(url);else window.location=url;self.displayMessage(true,false,$current.text());self.closePalette(ev)}}}else if(self.isAction){var variables=self.actionData.vars;variables["searchText"]=self.$searchField.val();self.loading=true;self.triggerCallback(self.actionData.call,self.actionData.service,variables)}ev.preventDefault()}},triggerCallback:function(name,service,vars){var self=this,displayDefaultMessage=false,$current=self.$commands.filter(".focus").children(".amcommand__commands--name");
self.$commands.hide();self.$loader.removeClass("hidden");Craft.postActionRequest("amCommand/commands/triggerCommand",{command:name,service:service,vars:vars},$.proxy(function(response,textStatus){if(textStatus=="success"){self.loading=false;self.$loader.addClass("hidden");if(response.success){if(self.isAction){self.isAction=false;self.actionData=[];self.$buttonExecute.addClass("hidden");self.$searchContainer.removeClass("amcommand__search--hasButton")}if(response.isAction){self.loadedNewCommands=
true;self.isAction=true;self.actionData=response.isAction;self.$tabsContainer.text(response.isAction.tabs);self.$tabsContainer.removeClass("hidden");self.$buttonExecute.removeClass("hidden");self.$searchContainer.addClass("amcommand__search--hasButton");self.$commandsContainer.html("");self.resetPalette();self.$searchField.val(response.isAction.searchText);self.$searchField.focus()}else if(response.isNewSet)if(response.result=="")self.$commands.show();else{self.loadedNewCommands=true;self.$tabsContainer.text(self.loadingCommand);
self.$tabsContainer.removeClass("hidden");self.$commandsContainer.html(response.result);self.resetPalette()}else if(response.deleteCommand){$current.parent().addClass("hidden");self.$commands.show();self.$commands.removeClass("focus");self.$commands.filter(":visible").first().addClass("focus");self.$searchField.focus();if(self.$commands.filter(":visible").length<=0){self.displayMessage(false,Craft.t("There are no more commands available."),false);self.closePalette()}}else{displayDefaultMessage=true;
self.closePalette()}if(response.message)self.displayMessage(response.result!="",response.message,false);else if(displayDefaultMessage)self.displayMessage(true,false,$current.text());if(response.redirect)window.location=response.redirect}else{self.$commands.show();self.displayMessage(false,response.message,false)}}},self))}})})(jQuery);